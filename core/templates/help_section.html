{% extends 'base.html' %}
{% block title %}
Help & Discussion
{% endblock %}
{% block content %}
<div class="help_banner">
    <h2>Help & Discussion</h2>
</div>

<div class="help_section_warper">
    <div class="help_section_container">

        {% for post in posts %}
        <div class="post_box">
            <h3>{{ post.title }}</h3>

            {% with post.content|truncatewords:10 as short_content %}
                <p id="short-content-{{ post.id }}">
                    {{ short_content }}...
                    <a style="text-decoration:none ;color:#00c6ff;" href="javascript:void(0);" onclick="toggleContent({{ post.id }}, true)">See More</a>
                </p>
                <p id="full-content-{{ post.id }}" style="display: none;">
                    {{ post.content }}
                    <a style="text-decoration:none ;color:#00c6ff;" href="javascript:void(0);" onclick="toggleContent({{ post.id }}, false)">See Less</a>
                </p>
            {% endwith %}

            {% if post.image %}
                <img class="img_post" src="{{ post.image.url }}" style="max-width:100%; height:auto; border-radius:5px;"><br>
            {% endif %}
            <small style="font-family: poppins;">Posted by Member at {{ post.created_at }}</small>

            <div style="margin-top: 10px;">
                <button onclick="toggleComments({{ post.id }})" id="toggle-comments-{{ post.id }}">Show Comments</button>
                <div id="comments-{{ post.id }}" style="display: none; margin-top: 10px;">
                    <h4>Comments:</h4>
                    {% for comment in post.comments.all %}
                        <p><b>{{ comment.user.username }}:</b> {{ comment.content }}</p>
                        {% empty %}
                        <p class="no-comments">No comments yet.</p>
                    {% endfor %}
                    <form method="POST" action="{% url 'create_comment' %}" class="comment-form" data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="post_id" value="{{ post.id }}">
                        <input type="text" name="content" placeholder="Comment..." required>
                        <button type="submit">Comment</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>
</div>

<!-- Content Toggle Script (unchanged) -->
<script>
    function toggleContent(postId, showFull) {
        const shortEl = document.getElementById(`short-content-${postId}`);
        const fullEl = document.getElementById(`full-content-${postId}`);
        if (showFull) {
            shortEl.style.display = 'none';
            fullEl.style.display = 'block';
        } else {
            fullEl.style.display = 'none';
            shortEl.style.display = 'block';
        }
    }
    
    function toggleComments(postId) {
        const section = document.getElementById(`comments-${postId}`);
        const button = document.getElementById(`toggle-comments-${postId}`);
        const isVisible = section.style.display === 'block';
    
        section.style.display = isVisible ? 'none' : 'block';
        button.textContent = isVisible ? 'Show Comments' : 'Hide Comments';
    }
    
    // üí¨ AJAX comment submit
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
    
            const postId = this.dataset.postId;
            const contentInput = this.querySelector('input[name="content"]');
            const content = contentInput.value.trim();
            const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
    
            if (content === '') {
                alert("‚ùå Comment cannot be empty.");
                return;
            }
    
            const formData = new FormData();
            formData.append('post_id', postId);
            formData.append('content', content);
    
            fetch("{% url 'create_comment' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        console.error("Error Response:", data);
                        alert("‚ùå " + (data.error || "Something went wrong."));
                        return;
                    }
    
                    const commentsDiv = document.getElementById(`comments-${postId}`);
                    const noCommentsParagraph = commentsDiv.querySelector('.no-comments');
                    if (noCommentsParagraph) {
                        noCommentsParagraph.remove();
                    }
    
                    const newCommentHTML = `<p><b>${data.username}:</b> ${data.content}</p>`;
                    commentsDiv.insertAdjacentHTML('afterbegin', newCommentHTML);
                    contentInput.value = '';
                });
            })
            .catch(error => {
                console.error("AJAX Fetch Failed:", error);
                alert("‚ö†Ô∏è Something went wrong while submitting your comment.");
            });
        });
    });
    </script>
    
{% endblock %}
